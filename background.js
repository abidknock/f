(()=>{let e=[],t=[],o=[],i=[],n=[],a=!0;const r=(new Date).getMonth(),s="26.1.3",d="260103",l=1180,c="trill",u="api16-normal-c-useast1a.tiktokv.com",m="v1";let f=!1;chrome.runtime.onInstalled.addListener((function(e){if("install"===e.reason){chrome.storage.local.set({tartempion:!1}),chrome.storage.local.set({buttonRef:0}),chrome.storage.local.set({hideAllBtns:!1}),chrome.storage.local.set({monthSaved:r}),chrome.storage.local.set({useCount:0}),chrome.storage.local.set({ratingAsked:!1});const e="https://docs.google.com/forms/d/e/1FAIpQLSfFRXV3rOg1micFGUNnWDB5KjhEvQAMt6D3WTVjiHlRXk4Pew/viewform?usp=sf_link";chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL(e)}})),chrome.webRequest.onSendHeaders.addListener((async function(o){if(!e.includes(o.url)){e.push(o.url);let i=o.requestHeaders.find((e=>"x-tt-params"===e.name)).value,n=!1;const a=await fetch(o.url,{headers:{"x-tt-params":i}}).catch((e=>{console.log(e+" | "+o.url),chrome.storage.local.set({hasMore:!1}),n=!0}));if(!n){const e=await a.json(),o=e.hasMore;chrome.storage.local.set({again:o});let i=e.itemList;if(w(i))for(let e of i){let o={user:e.author.uniqueId,id:e.video.id,downloadAddr:e.video.downloadAddr,timestamp:e.createTime},i=!1;for(let e of t)e.id===o.id&&(i=!0);i||t.push(o),i=!1}}}}),{urls:["*://*.tiktok.com/api/post/item*"]},["requestHeaders"]),chrome.webRequest.onSendHeaders.addListener((async function(t){if(!e.includes(t.url)){e.push(t.url);let i=!1;const n=await fetch(t.url).catch((e=>{console.log(e+" | "+t.url),i=!0}));if(!i){let e=(await n.json()).itemList;if(w(e))for(let t of e){let e={user:t.author.uniqueId,id:t.video.id,downloadAddr:t.video.downloadAddr,timestamp:t.createTime},i=!1;for(let t of o)t.id===e.id&&(i=!0);i||o.push(e),i=!1}}}}),{urls:["*://*.tiktok.com/api/favorite/item*"]},["requestHeaders"]),chrome.runtime.onMessage.addListener((function(e){"cancelDownload"===e.action&&(f=!0)})),chrome.runtime.onMessage.addListener((async function(r,l,c){if("feedReset"===r.reset?(i=[],n=[]):"profilReset"===r.reset&&(t=[],o=[],e=[],n=[]),"feedFetch"===r.action){if(r.users&&r.firstVideos){i=[];for(let e=0;e<r.firstVideos.length;e++){let t={user:r.users[e],id:r.firstVideos[e].id,downloadAddr:r.firstVideos[e].url},o=!1;for(let e of i)e.id===t.id&&(o=!0);o||i.push(t),o=!1}}}else if("listenFeed"===r.action&&r.responseBody)for(let e of r.responseBody){let o={user:e.author.uniqueId,id:e.id,downloadAddr:e.video.downloadAddr},n=!1;for(let e of t)e.id===o.id&&(n=!0);n||i.push(o),n=!1}if("profilFetch"===r.action){if(r.user&&r.firstVideos&&r.itemModule){t=[];for(let e of r.firstVideos){let o=r.user,i=e.id,n={user:o,id:i,downloadAddr:e.url,timestamp:r.itemModule[i].createTime},a=!1;for(let e of t)e.id===n.id&&(a=!0);a||t.push(n),a=!1}}}else"getNumberProfilVideos"===r.action&&(a=await h("onVideos"),a?chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{listLength:t.length})})):chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{listLength:o.length})})));if("downloadOne"===r.action){let e=!1,t=r.username+"-"+r.videoId;t=t.replace(".","-"),t+=".mp4";const o=r.buttonId;let i=v(r.videoId,s,d);const a=await _(i,r.withoutWatermark);chrome.downloads.download({url:a,filename:t},(function(e){const t=[o,e];n.push(t)})),chrome.storage.local.get(["useCount"]).then((e=>{let t=e.useCount;t++,chrome.storage.local.set({useCount:t})})),e=!0}else if("downloadAll"===r.action){let e=0;"10"===r.nbVideos?e=10:"25"===r.nbVideos?e=25:"all"===r.nbVideos&&(a=await h("onVideos"),e=a?t.length:o.length);let i="";a=await h("onVideos"),i=a?t.length:o.length,async function(e,i,n){let r="";if(a=await h("onVideos"),r=a?t:o,f=!1,w(r))for(let t=0;t<e&&t<i;t++){if(f){f=!1;break}t===i-1&&chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{stopProfilLoaders:!0})}));let e=r[t].user+"-"+r[t].id;e=e.replace(".","-"),e+=".mp4";let o=v(r[t].id,s,d);const a=await _(o,n),l=await p(a,e);await g(l)}}(e,i,r.withoutWatermark)}else"downloadSelection"===r.action?async function(e,i){let n="";a=await h("onVideos"),n=a?e.map((function(e){return t.filter((t=>t.id===e))[0]})):e.map((function(e){return o.filter((t=>t.id===e))[0]})),f=!1;let r=!1;if(w(n))for(let t of e){r=!1;for(let e of n)if(t===e.id){if(f){f=!1;break}let o=e.user+"-"+e.id;o=o.replace(".","-"),o+=".mp4";let n=v(t,s,d);const a=await _(n,i),l=await p(a,o);await g(l),r=!0}}chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{stopProfilLoaders:!0})}))}(r.videoIdList,r.withoutWatermark):"calendarSelection"===r.action&&async function(e,i){let n=e[0]/1e3,r=e[e.length-1]/1e3;if(n>r){const e=n;n=r,r=e}r+=86400;let l="";if(a=await h("onVideos"),l=a?t:o,f=!1,w(l)){for(let e=0;e<l.length;e++){if(f){f=!1;break}if(l[e].timestamp>=n&&l[e].timestamp<=r){let t=l[e].user+"-"+l[e].id;t=t.replace(".","-"),t+=".mp4";let o=v(l[e].id,s,d);const n=await _(o,i),a=await p(n,t);await g(a)}}chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{stopProfilLoaders:!0})}))}}(await h("timestampSelection"),r.withoutWatermark)})),chrome.downloads.onCreated.addListener((function(e){const t=e.id;let o=!1;for(let e=0;e<n.length;e++){const i=n[e];i[1]===t&&(buttonToStopId=i[0],chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{stopLoader:!0,buttonToStopId})})),o=!0)}}));const h=async e=>new Promise(((t,o)=>{chrome.storage.local.get([e],(function(i){void 0===i[e]?o():t(i[e])}))}));function w(e){return null!=e&&"function"==typeof e[Symbol.iterator]}function p(e,t){return new Promise((o=>{chrome.downloads.download({url:e,filename:t},o),chrome.storage.local.get(["useCount"]).then((e=>{let t=e.useCount;t++,chrome.storage.local.set({useCount:t})}))}))}function g(e){return new Promise((t=>{chrome.downloads.onChanged.addListener((function o({id:i,state:n}){i===e&&n&&"in_progress"!==n.current&&(chrome.downloads.onChanged.removeListener(o),t("complete"===n.current))}))}))}function b(e,t=16){let o="",i=e.length;for(let n=0;n<t;n++)o+=e.charAt(Math.floor(Math.random()*i));return o}function v(e,t,o){const i=Math.round(Date.now()/1e3),n={aweme_id:e,version_name:t,version_code:o,build_number:t,manifest_version_code:o,update_version_code:o,openudid:b("0123456789abcdef",16),uuid:b("0123456789",16),_rticket:1e3*i,ts:i,device_brand:"Google",device_type:"Pixel 4",device_platform:"android",resolution:"1080*1920",dpi:420,os_version:"10",os_api:"29",carrier_region:"US",sys_region:"US",region:"US",app_name:c,app_language:"en",language:"en",timezone_name:"America/New_York",timezone_offset:"-14400",channel:"googleplay",ac:"wifi",mcc_mnc:"310260",is_my_cn:0,aid:l,ssmix:"a",as:"a1qwert123",cp:"cbfhckdckkde1"};return`https://${u}/aweme/${m}/feed/`+Object.keys(n).map(((e,t)=>`${t>0?"&":"?"}${e}=${n[e]}`)).join("")}async function _(e,t,o){let i=null;const n=await fetch(e,o),a=await n.json();return a?i=t?a.aweme_list[0].video.play_addr.url_list[0]:a.aweme_list[0].video.download_addr.url_list[0]:(console.log("Caught a fetching error:",error),i=null),i}})();